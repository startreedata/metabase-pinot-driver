name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == true) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start Pinot
      run: |
        chmod +x scripts/start-pinot-quickstart.sh
        ./scripts/start-pinot-quickstart.sh

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@13.4
      with:
        cli: 1.12.1.1550

    - name: Cache Clojure dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2
          ~/.gitlibs
          .cpcache
        key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-clojure-

    - name: Clone metabase if needed
      run: |
        echo "=== Checking metabase setup ==="
        if [ ! -d "metabase" ]; then
          echo "Metabase directory not found, cloning..."
          make clone_metabase_if_missing
        else
          echo "Metabase directory found"
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'yarn'
        cache-dependency-path: 'metabase/yarn.lock'

    - name: Install Node.js dependencies
      run: |
        # Use yarn instead of npm since metabase uses yarn
        if [ -f "metabase/yarn.lock" ]; then
          cd metabase && yarn install
        else
          echo "No yarn.lock found, skipping yarn install"
        fi

    - name: Setup driver and build
      run: |
        echo "=== Checking driver setup ==="
        if [ ! -L "metabase/modules/drivers/pinot" ]; then
          echo "Driver symlink not found, creating..."
          make link_to_driver
        else
          echo "Driver symlink found"
        fi
        
        echo "=== Updating deps files ==="
        make update_deps_files
        
        echo "=== Building frontend ==="
        make front_end
        
        echo "=== Building driver ==="
        cd metabase
        # Ensure metabase core is available on classpath by including dev alias
        # The :dev alias includes core source paths needed for metabase.util.ssh
        clojure -X:dev:build:drivers:build/driver :driver :pinot :edition :oss

    - name: Run tests with coverage
      run: |
        echo "=== Running Pinot driver tests with coverage ==="
        cd drivers/pinot
        
        # Run unit tests with coverage
        echo "Running unit tests with coverage..."
        clojure -X:test-coverage
        
        # Generate coverage report
        echo "Generating coverage reports..."
        
        # Also run using kaocha for better test reporting
        echo "Running tests with kaocha..."
        clojure -M:test-runner --config-file tests.edn --reporter kaocha.report/documentation
        
        echo "=== Test execution completed ==="

    - name: Upload test results and coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-and-coverage
        path: |
          drivers/pinot/target/coverage/
          drivers/pinot/target/test-results/
          metabase/test-results/
          metabase/coverage/
        retention-days: 30

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      if: always()
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: drivers/pinot/target/coverage/codecov.json
        directory: drivers/pinot/target/coverage/
        flags: pinot-driver
        name: pinot-driver-coverage
        fail_ci_if_error: false
        verbose: true

    - name: Comment coverage report
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          const path = 'drivers/pinot/target/coverage/codecov.json';
          
          if (fs.existsSync(path)) {
            const coverage = JSON.parse(fs.readFileSync(path, 'utf8'));
            const computePercent = (data) => {
              if (typeof data === 'number') return data;
              if (!data || typeof data.coverage !== 'object') return null;
              
              let covered = 0;
              let total = 0;
              
              for (const fileCoverage of Object.values(data.coverage)) {
                if (!fileCoverage) continue;
                const entries = Array.isArray(fileCoverage) ? fileCoverage : Object.values(fileCoverage);
                
                for (const v of entries) {
                  if (v === null || v === undefined) continue;
                  total += 1;
                  const hits = v === true ? 1 : v;
                  if (typeof hits === 'number' && hits > 0) {
                    covered += 1;
                  }
                }
              }
              
              return total ? (covered / total * 100) : null;
            };
            
            const percent = computePercent(coverage);
            const coveragePercent = percent !== null ? percent.toFixed(2) : 'N/A';
            
            const body = `## üìä Test Coverage Report
            
            **Pinot Driver Coverage**: ${coveragePercent}%
            
            Coverage details have been uploaded to the artifacts for this build.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          }

  lint:
    runs-on: ubuntu-latest
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == true) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@13.4
      with:
        cli: 1.12.1.1550

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2
          ~/.gitlibs
          .cpcache
        key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-clojure-

    - name: Run linting
      run: |
        cd drivers/pinot
        clojure -M:clj-kondo

  build:
    runs-on: ubuntu-latest
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == true) }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Set up Clojure CLI
      uses: DeLaGuardo/setup-clojure@13.4
      with:
        cli: 1.12.1.1550
    
    - name: Cache Clojure dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2
          ~/.gitlibs
        key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-clojure-
    
    - name: Clone metabase if needed
      run: |
        echo "=== Checking metabase setup ==="
        if [ ! -d "metabase" ]; then
          echo "Metabase directory not found, cloning..."
          make clone_metabase_if_missing
        else
          echo "Metabase directory found"
        fi
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'yarn'
        cache-dependency-path: 'metabase/yarn.lock'
    
    - name: Install Node.js dependencies
      run: |
        # Use yarn instead of npm since metabase uses yarn
        if [ -f "metabase/yarn.lock" ]; then
          cd metabase && yarn install
        else
          echo "No yarn.lock found, skipping yarn install"
        fi
    
    - name: Build metabase and driver
      run: |
        echo "=== Starting build ==="
        
        echo "=== Checking driver setup ==="
        if [ ! -L "metabase/modules/drivers/pinot" ]; then
          echo "Driver symlink not found, creating..."
          make link_to_driver
        else
          echo "Driver symlink found"
        fi
        
        echo "=== Updating deps files ==="
        make update_deps_files
        
        echo "=== Building frontend ==="
        make front_end
        
        echo "=== Building driver ==="
        cd metabase
        # Ensure metabase core is available on classpath by including dev alias
        # The :dev alias includes core source paths needed for metabase.util.ssh
        clojure -X:dev:build:drivers:build/driver :driver :pinot :edition :oss
        cd ..
        
        echo "=== Checking if driver JAR was created ==="
        if [ -f "metabase/resources/modules/pinot.metabase-driver.jar" ]; then
          echo "‚úÖ Driver JAR successfully created"
          echo "üì¶ JAR size: $(du -h metabase/resources/modules/pinot.metabase-driver.jar | cut -f1)"
        else
          echo "‚ùå Driver JAR not found"
          echo "=== Debugging: listing metabase/resources/modules/ ==="
          ls -la metabase/resources/modules/ || echo "Directory not found"
          exit 1
        fi
    
    - name: Verify driver JAR contents
      run: |
        echo "üìã JAR contents (first 10 files):"
        jar -tf metabase/resources/modules/pinot.metabase-driver.jar | head -10
        echo "üìã JAR size and details:"
        ls -la metabase/resources/modules/pinot.metabase-driver.jar
    
    - name: Run driver verification
      run: clojure verify_driver.clj

  security:
    # Secrets are not available for PRs from forks; only run when secrets can be read.
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Clojure
      uses: DeLaGuardo/setup-clojure@13.4
      with:
        cli: 1.12.1.1550

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2
          ~/.gitlibs
          .cpcache
        key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-clojure-

    - name: Run security scan
      env:
        NVD_API_TOKEN: ${{ secrets.NVD_API_KEY }}
      run: |
        cd drivers/pinot
        clojure -J-Dnvd.api.key="$NVD_API_TOKEN" -M:security-scan nvd-clojure.edn $(clojure -Spath -M:security-scan-cp)
